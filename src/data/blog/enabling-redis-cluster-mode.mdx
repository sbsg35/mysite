---
featured: true
title: 'Journey to fully serverless Redis'
summary: 'Part 1, enabling Redis Cluster'
published: '04/30/2024'
last_modified: '04/30/2024'
author_name: 'Raj Ghuman'
author_image: '/static/avatar.jpeg'
thumbnail: '/static/redis.png'
tags: ['AWS', 'Elasticache', 'Backend', 'Devops', 'Redis', 'Databases']
keywords: ['AWS Elasticache', 'Redis Cluster Mode']
---


Redis cluster allows data to be split across multiple nodes. AWS Elasticache makes it easy to migrate from a single node (Cluster mode disabled or CMD) to a Redis cluster (Cluster mode enabled or CME).

I recently migrated a single Redis instance to a Redis Cluster in AWS at my current company. Later, I updated to Serverless Elasticache. Here is part 1 of the journey.

## Why change to cluster mode? Pain points

Some of the pain points

- Can only scale vertically. With AWS sizing, that can mean very high cost increments (e.g. going from 8xl to 16xl)
- Single point of failure, if the instance went down, for whatever reason, all data would be lost.
- No way to handle spiky traffic, other than grossly over provisioning
- Scaling up before high traffic events was required. Not the worst but a manual process none the less.

## What is Redis cluster mode?

In a Redis cluster, data is distributed in "shards". A shard is a "split" of the database. In AWS Elasticache, you can have 1-500 shards, with 1-5 read replicas each.

Redis decides which shards keys are inserted into “keyslots” using a simple hashing algorithm. A Redis Cluster has exactly 16384 keyslots. For a 2 shard cluster, here’s how we can compute the algorithm to determine which slot the keys belong to.

```bash
> cluster keyslot "mykey" // 14687 --> Shard 2

> cluster keyslot "anotherkey" // 2538 --> Shard 1
```

For AWS this means having your writers split and replicated across multiple availability zones.

## Migration process

AWS makes the process from going to CMD to CME very easy.

1. Ensure Redis engine is on v7
2. Ensure there is a read replica
3. In the console switch to "Cluster mode compatible" (CMC)
4. Client libraries updated ( `createClient` → `createCluster` ). I had to update node-redis V3, to V4 in this case.
   - In CMC, both `createClient` and `createCluster` client constructors work.
   - Use the configuration endpoint generated by AWS, in the `createCluster` constructor
5. Test the application thoroughly in this state
   - run any unit tests and end to end tests here
6. Once happy, Switch to "Cluster mode enabled"
7. The new Redis Cluster starts off with 1 shard and 1 read replica. You can optionally update your cluster configuration. Redis recommends a minimum 6 node cluster, with 3 shards.

<img
  src={'/static/elasticache.png'}
  style={{borderRadius: "0.25rem"}}
  alt="image showing cluster setup from CMD to CMC to CME"
/>

## Application autoscaling

We added Application autoscaling to increase/decrease number of shards based on desired metrics (CPU/RAM) etc.

## Advantages

- If a shard went down, only a portion of the data would be lost.
- Adding read replicas improved resiliency, as the replicas are automatically distributed across AZs.
- Can achieve much higher throughput (keeping an eye on cost)
- With autoscaling, issues with spiky traffic can be mitigated

## New pain points

- More complex infra to manage
  - e.g. cluster configuration, application autoscaling
- increased costs due to having more nodes (although this was reduced somewhat be scaling down vertically)

## Enter Elasticache Serverless

Shortly after this migration AWS announced Elasticache Serverless. I’ll share the decision making behind switching to this in part two.
